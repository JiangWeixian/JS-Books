# 从代码编译入手
[[toc]]

> 虽然对`js`来说。编译是个不太需要的知识点。这里所说的编译指的是`es5->es6`，以及`ts->js`都可以这么认为。

## Package.json

**15->16** 构建工具的改变，依照[React-15.x](https://github.com/numbbbbb/read-react-source-code/blob/master/01-start-with-the-messy-build-process.md)里面提到的，构建工具从`grunt`变成了`rollup`。 

> 目的是为了支持多个版本的`JS`代码。主要是模块的`JS`模块的使用方式。所以这一点是和`babel`并没有冲突的，`babel`主要作用是`compile to es5`（不只是`JS`模块的使用）

从`package.json`的`scripts`查看脚本文件。

```json
{
  "scripts": {
    "build": "node ./scripts/rollup/build.js",
    "linc": "node ./scripts/tasks/linc.js",
    "lint": "node ./scripts/tasks/eslint.js",
    "lint-build": "node ./scripts/rollup/validate/index.js",
    "postinstall": "node node_modules/fbjs-scripts/node/check-dev-engines.js package.json && node ./scripts/flow/createFlowConfigs.js",
    "debug-test": "cross-env NODE_ENV=development node --inspect-brk node_modules/.bin/jest --config ./scripts/jest/config.source.js --runInBand",
    "test": "cross-env NODE_ENV=development jest --config ./scripts/jest/config.source.js",
    "test-persistent": "cross-env NODE_ENV=development jest --config ./scripts/jest/config.source-persistent.js",
    "test-fire": "cross-env NODE_ENV=development jest --config ./scripts/jest/config.source-fire.js",
    "test-new-scheduler": "cross-env NODE_ENV=development jest --config ./scripts/jest/config.source-new-scheduler.js",
    "test-prod": "cross-env NODE_ENV=production jest --config ./scripts/jest/config.source.js",
    "test-fire-prod": "cross-env NODE_ENV=production jest --config ./scripts/jest/config.source-fire.js",
    "test-prod-build": "yarn test-build-prod",
    "test-build": "cross-env NODE_ENV=development jest --config ./scripts/jest/config.build.js",
    "test-build-prod": "cross-env NODE_ENV=production jest --config ./scripts/jest/config.build.js",
    "flow": "node ./scripts/tasks/flow.js",
    "flow-ci": "node ./scripts/tasks/flow-ci.js",
    "prettier": "node ./scripts/prettier/index.js write-changed",
    "prettier-all": "node ./scripts/prettier/index.js write",
    "version-check": "node ./scripts/tasks/version-check.js"
  }
}
```

去掉其中的

* `test-*`部分 - 代表的是测试
* `flow-*` - 类似的是`ts`的强类型语言
* `lint-* & prettier-*` - 代表的是代码美化脚本文件

**所以有用的为：** `build`

## scripts-build做了什么？
> 不清楚这样的阅读方式对不对...，先尝试

进入`scripts/rollup/build.js`

```js
const {rollup} = require('rollup'); // rollup核心
const babel = require('rollup-plugin-babel');
const closure = require('./plugins/closure-plugin');
const commonjs = require('rollup-plugin-commonjs');
const prettier = require('rollup-plugin-prettier');
const replace = require('rollup-plugin-replace');
const stripBanner = require('rollup-plugin-strip-banner');
const chalk = require('chalk');
const path = require('path');
const resolve = require('rollup-plugin-node-resolve');
const fs = require('fs');
const argv = require('minimist')(process.argv.slice(2));
const Modules = require('./modules');
const Bundles = require('./bundles');
const Stats = require('./stats');
const Sync = require('./sync');
const sizes = require('./plugins/sizes-plugin');
const useForks = require('./plugins/use-forks-plugin');
const stripUnusedImports = require('./plugins/strip-unused-imports');
const extractErrorCodes = require('../error-codes/extract-errors');
const Packaging = require('./packaging');
const {asyncCopyTo, asyncRimRaf} = require('./utils');
const codeFrame = require('babel-code-frame');
const Wrappers = require('./wrappers');
```

先提取`rollup`相关部分：

* `{ rollup }` - rollup核心
* `babel & commonjs` - 一个支持`es5`不支持的特性（使得可以运行在大多数浏览器上，这也是`babel`的主要作用），另外一个支持的是[`commonjs`转化为`es6`](https://github.com/rollup/rollup-plugin-commonjs)

  > // Compile to ES5. babel(getBabelConfig(updateBabelOptions, bundleType)) 代码注释也写得很清楚

* [`replace`](https://github.com/rollup/rollup-plugin-replace) - 代码中也只有一处地方使用到了.
  ```js
  replace({
    __DEV__: isProduction ? 'false' : 'true',
    __PROFILE__: isProfiling || !isProduction ? 'true' : 'false',
    __UMD__: isUMDBundle ? 'true' : 'false',
    'process.env.NODE_ENV': isProduction ? "'production'" : "'development'",
  })
  ```

  可以理解为在代码输入到`rollup`之后，会把代码中的相关`string`通过替换的方式，替换为新的字符串。

* `stripBanner` - 移除**JS**文件中类似`MIT-License`相关文字。
* `resolve` - 可以理解为`rollup`其实不明白如何处理来自`npm install`的安装包(这一点和`webpack`不同)。所以需要添加这个`plugin`

**在rollup文件夹中还有其他的文件夹。具体是什么作用？** 但是这些自建模块的作用可能是需要开始阅读`rollup/build.js`才能够理解了。

### 不太重要的模块

其中有些是`nodejs`内置的模块

* fs
* path

> 具体什么功能等下再看。估计是预处理一些文件。方便打包

**不太重要的第三方包**

* `chalk` - 是为了美化`node`输出的

### 开始阅读

> **文件由上往下：**（会跳过不太重要的代码段，或者一笔带过）

**错误处理** - `process.on('unhandledRejection'` 这部分是处理错误。

:::warning
但是我在代码中没见到抛出这个错误的代码。由于对`react`理解影响不大，所以暂时跳过。
:::

**Bundles** - 定义被所有打包好文件类型。

> 因为从`bundle`这个单词理解，指的是就是打包后的`file`。从变量的命名规则可以分为`X_Y`的格式。

* 其中`Y` - `dev prod`以及`profill`三个版本（很好理解）
* `X` - 指的是运行的平台
  * 有`rn` - `react-native`
  * `node` - 应该是服务器
  * `umd` - 一种和`commonjs`相同`level`的模块使用方式。支持服务器和浏览器
  * `fb` - 这个没弄明白是怎样的类型

```js
const {
  ...// some variables
} = Bundles.bundleTypes
```

来自自建模块`./bundles.js`。直观理解的话，定义了`react`模块，以及模块之间从属关系，以及入口文件，引用了哪些模块？

而且通过[freeze方法](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze)避免该文件被修改。

**Argv** - 处理命令行从`line:56 - line: 98`。可以从[react-development-workflow](https://reactjs.org/docs/how-to-contribute.html#development-workflow)查看到使用方式

> `yarn`执行`scripts`等价于`npm run scripts`。可以通过`argv`指定编译的模块(`X_Y`)

**Babel`(func getBabelConfig)`** - 处理不同的编译`type`。也就是上面所说的`X`。导入了处理不同平台`react`的`babel`工具。定义在了`babel`文件夹中。

**rollup`(func getRollupOutputOptions)`** - 输出`rollup`配置文件

  ```js
  outputPath,
  format,
  globals,
  globalName,
  bundleType
  ```

  从函数参数可以发现，应该有几个服务于它的辅助函数。

* `outputPath` - 指的是`rollup`打包好的文件保存路径。需要和`getFilename`结合使用。通过`X_Y`中`X or Y`生成打包地址。
* `format` - 辅助函数`getFormat`，通过`argv.type`输出打包为`umd or cjs`
* `globalName` - equal `X_Y`

**createBundle** - 开始打包，可以理解为`build.js`入口函数了。其他都是要服务它存在的。


即可以通过命令行的方式指定编译模块，也可以打包所有模块。
